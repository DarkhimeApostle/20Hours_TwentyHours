# T20 配置备份功能

## 功能概述

T20 现在支持完整的配置备份和恢复功能，包括：

- 所有技能数据（主页面和荣耀殿堂）
- 技能日记内容
- 技能分组数据
- 用户头像和侧边栏背景图片
- 用户名设置
- 技能祝贺记录
- 智能权限管理（自动请求存储权限）

## 使用方法

### 权限管理

1. **自动权限请求**：应用启动时会自动请求存储权限
2. **手动权限管理**：在设置页面可以查看和重新请求存储权限
3. **权限状态显示**：设置页面会显示当前权限状态和说明
4. **智能存储选择**：根据权限状态选择最佳存储位置

### 导出配置

1. 打开应用，进入 **设置** 页面
2. 点击 **导出配置** 选项
3. 在文件夹选择器中选择保存位置（建议选择容易找到的目录，如"下载"或"文档"）
4. 系统会自动导出所有数据到选择的文件夹
5. 导出完成后会显示成功提示

### 导入配置

1. 打开应用，进入 **设置** 页面
2. 点击 **导入配置** 选项
3. 在文件夹选择器中选择之前导出的备份文件夹（包含 `config.json` 的文件夹）
4. 系统会自动验证并恢复所有数据
5. 导入完成后会提示重启应用以应用更改

## 备份文件结构

备份文件会保存在固定位置，每次导出会覆盖之前的备份：

```
用户选择的目录/t20_backup/
├── config.json          # 配置文件（包含所有技能数据和设置）
├── avatar.png           # 用户头像（如果存在）
└── drawer_bg.png        # 侧边栏背景（如果存在）
```

**建议保存位置**：
- `/storage/emulated/0/Download/` - 下载文件夹
- `/storage/emulated/0/Documents/` - 文档文件夹
- `/storage/emulated/0/DCIM/` - 图片文件夹

## 配置文件格式

`config.json` 文件包含以下数据结构：

```json
{
  "version": "1.0",
  "exportTime": "2024-01-01T12:00:00.000Z",
  "userInfo": {
    "userName": "用户名",
    "avatarPath": "avatar.png",
    "drawerBgPath": "drawer_bg.png"
  },
  "skills": {
    "mainSkills": [...],      // 主页面技能列表
    "hallOfGlorySkills": [...] // 荣耀殿堂技能列表
  },
  "diaries": {
    "技能名称": ["日记内容1", "日记内容2", ...]
  },
  "congratulatedSkills": ["技能ID1", "技能ID2", ...],
  "groups": [
    {
      "id": "分组ID",
      "name": "分组名称",
      "color": 颜色值,
      "order": 排序值
    }
  ]
}
```

## 注意事项

1. **覆盖保存**：每次导出都会覆盖之前的备份文件，只保留最新的一份
2. **固定位置**：备份文件保存在固定的 `t20_backup` 文件夹中
3. **文件夹选择**：导入时需要选择包含 `config.json` 文件的整个文件夹
4. **权限管理**：应用会自动请求存储权限，用户也可以在设置中手动管理
5. **建议位置**：建议将备份保存在容易找到的目录中，如下载文件夹
3. **图片备份**：头像和背景图片会自动复制到备份文件夹中
4. **数据完整性**：导入时会验证配置文件版本和完整性
5. **重启应用**：导入完成后需要重启应用以确保所有更改生效
6. **兼容性**：当前版本支持配置文件版本 1.x
7. **易于查找**：Android 文件夹是用户熟悉的目录，便于找到备份文件
8. **导入方式**：导入时选择 **config.json** 文件，系统会自动查找同目录下的图片文件

## 故障排除

### 导出失败
- 检查应用是否有足够的存储空间
- 确保图片文件存在且可访问

### 导入失败
- 确保选择了正确的 **config.json** 配置文件
- 检查配置文件是否存在且完整
- 验证配置文件版本是否兼容
- 确保配置文件与图片文件在同一目录中

### 数据不完整
- 重启应用以确保所有数据正确加载
- 检查是否有权限问题

## 技术实现

- 使用 `SharedPreferences` 存储技能数据和设置
- 使用 `path_provider` 管理文件路径
- 使用 `file_picker` 选择配置文件（支持 .json 格式）
- 图片文件通过文件系统直接复制
- 支持版本控制和数据验证
- 备份文件保存在 **Android/T20** 文件夹中，便于用户查找和管理 